<!doctype html>
<!-- See http://www.firepad.io/docs/ for detailed embedding docs. -->
<html>

<head>
    <meta charset="utf-8"/>

    <!-- CodeMirror -->
    <script src="assets/codemirror.js"></script>
    <link rel="stylesheet" href="assets/codemirror.css"/>

    <!-- Firepad -->
    <link rel="stylesheet" href="assets/firepad.css"/>
    <script src="../dist/firepad.js"></script>
    <script src="assets/jquery-3.1.1.min.js"></script>

    <link rel="stylesheet" href="style.css">

    <style>
        html {
            height: 100%;
        }

        body {
            margin: 0;
            height: 100%;
            position: relative;
        }

        /* Height / width / positioning can be customized for your use case.
           For demo purposes, we make firepad fill the entire browser. */
        #firepad-container {
            width: 100%;
            height: 100%;
        }
    </style>

</head>


<body onload="">
<!-- <div class="status"></div> -->
<div id="firepad-container"></div>

<script>
    var escape_str = function addslashes(str) {
        return (str + '').replace(/[\\"']/g, '\\$&').replace(/\u0000/g, '\\0');
    }

    var firepad;
    var code_mirror;
    (init = function init() {
        //// Create CodeMirror (with lineWrapping on).
        code_mirror = CodeMirror(document.getElementById('firepad-container'), {lineWrapping: true});

        //// Create Firepad (with rich text toolbar and shortcuts enabled).
        firepad = Firepad.fromCodeMirror(code_mirror,
            {richTextToolbar: true, richTextShortcuts: true});

        var get_current_line_attrs = function () {
            return firepad.richTextCodeMirror_.getCurrentAttributes_();
        }


        toggle_buttons_colors = function (btn_type, new_status) {
            var btn;
//            console.log(node, action);
            var class_name = "firepad-tb-" + btn_type;
            var selector = "." + class_name;
            node = $(selector);

            if (node[0].nodeName == 'SPAN') {
                btn = node.parent();
            } else {
                btn = node;
            }

            if (new_status == 'active') {
                btn.attr("data-active", "1");
                btn.css("background-color", "#d07ee5");
                btn.css("color", "#fcfcfc");
            }
            else if (new_status == 'inactive') {
                btn.attr("data-active", "0");
                btn.css("background-color", "#fcfcfc");
                btn.css("color", "#9c9c9c");
            }
            else {

                var data_active = btn.attr("data-active");

                if (data_active == 0) {
                    btn.attr("data-active", "1");
                    btn.css("background-color", "#d07ee5");
                    btn.css("color", "#fcfcfc");
                }
                else {
                    btn.attr("data-active", "0");
                    btn.css("background-color", "#fcfcfc");
                    btn.css("color", "#9c9c9c");
                }
            }
        }

        var cursor_activity_callback = function () {
//            console.log("cursor changed");
            if (code_mirror.lineCount() >= 0 && (firepad.getText().length > 2)) {
//                console.log("in if");
//                console.log("firepad.getText() is : " + firepad.getText());
//                console.log(get_current_line_attrs());
                var attr_obj = get_current_line_attrs();
//                console.log(attr_obj);
                if (attr_obj.b !== undefined) {
                    toggle_buttons_colors('bold', "active");
                }
                else {
                    toggle_buttons_colors("bold", "inactive");
                }

                if (attr_obj.i !== undefined) {
                    toggle_buttons_colors("italic", "active");
                }
                else {
                    toggle_buttons_colors("italic", "inactive");
                }

                if (attr_obj.u !== undefined) {
                    toggle_buttons_colors("underline", "active")
                }
                else {
                    toggle_buttons_colors("underline", "inactive");
                }

                if (attr_obj.s !== undefined) {
                    toggle_buttons_colors("strikethrough", "active")
                }
                else {
                    toggle_buttons_colors("strikethrough", "inactive");
                }



            }

        }

        code_mirror.on("cursorActivity", function () {
            // settimeout for cursor event to propogate and after that we want
            setTimeout(cursor_activity_callback, 50);
        });


        var timeout_id;
        var status = $('div.status');

        // This will set a timeout for note save
        var trigger_save_note = function (timeout) {
            status.text("changes pending");
            if (timeout_id) {
                clearTimeout(timeout_id);
            }
            timeout_id = setTimeout(function () {
                if (firepad.getHtml()) {
                    console.error("note_text$" + firepad.getHtml());
                    status.text("changes saved");
                }
            }, timeout);
        }

        code_mirror.on('keypress', function (e) {
            trigger_save_note(1000);
        });

        // Adding note save triggers for backspace and delete keypress
        $('#firepad-container').on('keydown', function (e) {
            var key = e.keyCode || e.charCode;
            if (key == 8 || key == 46 || key == 13) {
                trigger_save_note(600);
            }

        });

         $(".CodeMirror").on('keypress', function (e) {

//            console.log(e.ctrlKey, e.shiftKey, e.metaKey);
//            console.log(e);


             if (e.ctrlKey && e.shiftKey && e.keyCode === 187) {
                 var target = $(".firepad-richtext .CodeMirror ");
                         var current_font_size = target.css("font-size").split("px")[0];
                         target.css("font-size", String(parseInt(current_font_size)+1)+"px");
//                         console.log("Neew font size is ", target.css("font-size"));
             }
             else if (e.ctrlKey && e.keyCode === 189) {
                 var target = $(".firepad-richtext .CodeMirror ");
                var current_font_size = target.css("font-size").split("px")[0];
                target.css("font-size", String(parseInt(current_font_size)-1)+"px");
//                 console.log("Neew font size is ", target.css("font-size"));

             }
        });




        // Adding note save triggers for shortcut key ctrl + B, ctrl + I, ctrl + U
        $(".CodeMirror").on('keydown', function (e) {

//            console.log(e.ctrlKey, e.shiftKey, e.metaKey);
//            console.log(e);

            if ((e.metaKey || e.ctrlKey) && (String.fromCharCode(e.which).toLowerCase() === 'b')) {
//                trigger_save_note(300);
                $(".firepad-tb-bold").parent().trigger('click');
                return false;
            }

            else if ((e.metaKey || e.ctrlKey) && (String.fromCharCode(e.which).toLowerCase() === 'i')) {
                $(".firepad-tb-italic").parent().trigger('click');
                return false;

            }
            else if ((e.metaKey || e.ctrlKey) && (String.fromCharCode(e.which).toLowerCase() === 'u')) {
                $(".firepad-tb-underline").parent().trigger('click');
                return false;

            }

        });


        // Executing our keypress event after all the eventlisners execute thier code
        $.fn.lastHandler = function (events, handler) {
            var element = $(this);
            events = events.split(' ');
            for (var evt in events) {
                var event = $(element).data("events")[events[evt]];
                var hsucess = null;
                $.each(event, function (i, h) {
                    if (h.handler == handler) {
                        hsucess = h;
                    }
                });
                var index = event.indexOf(hsucess);
                if (index > -1) {
                    event.splice(index, 1);
                    event.push(hsucess);
                }
            }
        };

        $(".firepad-btn").attr("data-active", "0");


        // Adding note save triggers for rich text format buttons (top toolbar on note window)
        var onClickHandler = function (event) {

            node = $(event.target);

            if (node[0].nodeName == 'A') {
                btn = node.children();
            } else {
                btn = node;
            }
            var btn_type_list = ['bold', 'italic', 'underline', 'srikethrough'];
            // skiping 11 chars from class name ex: 'firepad-tb-bold' -> 'bold'
            var btn_type = btn[0].className.slice(11);

            if (btn_type_list.indexOf(btn_type) !== -1) {
                            toggle_buttons_colors(btn_type);

            }



            trigger_save_note(300);
        };

        $(".firepad-btn").click(onClickHandler);

        $(".firepad-btn").lastHandler(onClickHandler);

    })();


    // color theme changing code
    function GradientManager() {
        var self = {};
        var body = $("body");

        self.gradients = [
            {
                "gradient": "linear-gradient(to top, #dfe9f3 0%, white 100%)",
                "hover_color": "#ccc"
            }
        ]

        self.mappings = ['blue'];

        self.showMappings = function () {
            console.log(self.mappings);
        }

        self.changeBackground = function (gradient) {
            $("body").css("background-image", '"' + gradient + '"');
        }

        self.changeGradient = function (index) {
            var gradient = self.gradients[index]['gradient'];
            console.warn(gradient);
            self.changeBackground(gradient);

        }

        return self;
    }


</script>
</body>
</html>
